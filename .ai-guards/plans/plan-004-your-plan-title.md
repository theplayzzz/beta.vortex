---
id: plan-004
title: Otimiza√ß√£o de Performance da API de Clientes e Implementa√ß√£o do TanStack Query
createdAt: 2025-05-27
author: theplayzzz
status: draft
---

## üß© Scope

Otimizar a performance da API `/api/clients` que est√° apresentando lentid√£o significativa, implementar TanStack Query para gerenciamento de estado ass√≠ncrono, e corrigir o contador de clientes na dashboard que est√° mostrando valor incorreto (0).

## ‚úÖ Functional Requirements

- Reduzir significativamente o tempo de resposta da API `/api/clients`
- Implementar cache inteligente com TanStack Query
- Corrigir contador de clientes na dashboard para mostrar valor real
- Manter funcionalidade existente de filtros, pagina√ß√£o e ordena√ß√£o
- Implementar loading states e error handling adequados
- Adicionar invalida√ß√£o autom√°tica de cache quando necess√°rio

## ‚öôÔ∏è Non-Functional Requirements

- UX: Loading states suaves com skeleton loaders
- Caching: Cache inteligente com TTL configur√°vel
- Scalability: Suporte para grandes volumes de clientes sem degrada√ß√£o
- Reliability: Error boundaries e fallbacks para falhas de rede

## üìö Guidelines & Packages

- **TanStack Query v5**: Para gerenciamento de estado ass√≠ncrono e cache (MIT License)
  - **Documenta√ß√£o**: [TanStack Query Official Docs](https://tanstack.com/query/latest)
  - **React Guide**: [React Query Guide](https://tanstack.com/query/latest/docs/framework/react/guides/mutations)
- **React Query DevTools**: Para debugging em desenvolvimento
- **MCP Context7**: Para consulta de documenta√ß√£o oficial de todas as ferramentas
- **Prisma CLI**: Para an√°lise de impacto e migra√ß√µes seguras
- Seguir padr√µes existentes do projeto (TypeScript, Tailwind CSS)
- Manter compatibilidade com Clerk Auth e Prisma ORM
- Usar React 18+ features (Suspense, Error Boundaries)

## üîê Threat Model (Stub)

- Cache poisoning: Validar dados antes de armazenar em cache
- Memory leaks: Implementar cleanup adequado de queries
- Race conditions: Usar query keys √∫nicos e debouncing
- Unauthorized access: Manter valida√ß√£o de userId em todas as queries
- Database migration risks: Backup e rollback strategy
- Breaking changes: Versionamento de API durante transi√ß√£o

## üìã Problemas Identificados na An√°lise de Impacto

### üö® Problemas Cr√≠ticos Encontrados:

1. **Contador de Clientes Incorreto**
   - **Localiza√ß√£o**: `app/page.tsx` linha 32
   - **Problema**: Dashboard busca `data.total` mas API retorna `data.pagination.totalCount`
   - **Impacto**: Contador sempre mostra 0
   - **Refer√™ncia**: `.ai-guards/plans/impact-analysis.md` se√ß√£o "Contador de Clientes Incorreto"

2. **Query Desnecess√°ria de Industries**
   - **Localiza√ß√£o**: `app/api/clients/route.ts`
   - **Problema**: Query executada em TODA requisi√ß√£o mesmo quando n√£o necess√°ria
   - **Impacto**: Performance degradada desnecessariamente
   - **Refer√™ncia**: `.ai-guards/plans/impact-analysis.md` se√ß√£o "Query de Industries Desnecess√°ria"

3. **√çndices de Banco Faltantes**
   - **Problema**: Falta √≠ndices compostos para queries frequentes
   - **Impacto**: Queries lentas em tabelas grandes
   - **√çndices Necess√°rios**: `(userId, deletedAt, createdAt)`, `(userId, name)`, `(userId, industry, richnessScore)`
   - **Refer√™ncia**: `.ai-guards/plans/impact-analysis.md` se√ß√£o "Falta de √çndices Otimizados"

### üìÑ Documenta√ß√£o de Refer√™ncia:
- **An√°lise Completa**: `.ai-guards/plans/impact-analysis.md`
- **Vari√°veis de Ambiente**: `.ai-guards/plans/environment-variables.md`

### ‚ö†Ô∏è Corre√ß√µes Cr√≠ticas para Evitar Erros:

1. **ANTES de implementar TanStack Query**: Corrigir o bug do contador de clientes
   - **Motivo**: Evitar que o bug seja mascarado pela nova implementa√ß√£o
   - **A√ß√£o**: Alterar `data.total` para `data.pagination?.totalCount` em `app/page.tsx`

2. **DURANTE a Fase 4 (√çndices)**: Usar `CREATE INDEX CONCURRENTLY`
   - **Motivo**: Evitar lock da tabela Client em produ√ß√£o
   - **A√ß√£o**: Executar migra√ß√µes em hor√°rio de baixo tr√°fego

3. **MANTER compatibilidade**: N√£o alterar estrutura de resposta da API durante transi√ß√£o
   - **Motivo**: Evitar quebrar funcionalidades existentes
   - **A√ß√£o**: Implementar mudan√ßas de forma incremental e backward-compatible

## üî¢ Execution Plan

### **Fase 0: An√°lise e Prepara√ß√£o (CR√çTICA) ‚úÖ COMPLETA**

1. **‚úÖ Consultar documenta√ß√£o oficial via MCP Context7**
   - ‚úÖ TanStack Query v5: Sem breaking changes cr√≠ticos, compatibilidade confirmada
   - ‚úÖ Prisma: Documenta√ß√£o de √≠ndices compostos e performance consultada
   - ‚úÖ React 18: Suspense e Error Boundaries totalmente compat√≠veis
   - ‚úÖ Next.js: Padr√µes de API routes otimizadas identificados
   - **Resultado**: Todas as ferramentas s√£o compat√≠veis e seguras para uso

2. **‚úÖ An√°lise de impacto com Prisma**
   - ‚úÖ Executado `npx prisma db pull` - Schema sincronizado
   - ‚úÖ Executado `npx prisma generate` - Client atualizado
   - ‚úÖ Identificadas depend√™ncias da tabela `Client` (7 relacionamentos)
   - ‚úÖ Problemas identificados: Query desnecess√°ria de industries, √≠ndices faltantes, contador incorreto
   - **Arquivo**: `üìÑ .ai-guards/plans/impact-analysis.md` - An√°lise completa

3. **‚úÖ Backup e estrat√©gia de rollback**
   - ‚úÖ Branch `feature/performance-optimization` criada
   - ‚úÖ Estado atual documentado e commitado
   - ‚úÖ Crit√©rios de rollback definidos
   - **Arquivo**: `üìÑ .ai-guards/plans/environment-variables.md` - Vari√°veis documentadas

### **Fase 1: Otimiza√ß√µes Seguras (Sem Altera√ß√£o de Schema)**

4. **Implementar TanStack Query (Base)**
   - Instalar: `npm install @tanstack/react-query @tanstack/react-query-devtools`
   - Configurar QueryClient com configura√ß√µes conservadoras baseadas na [documenta√ß√£o oficial](https://tanstack.com/query/latest/docs/framework/react/quick-start)
   - Arquivo: `lib/query/client.ts` (novo)
   - Arquivo: `lib/query/keys.ts` (novo)
   - **Configura√ß√£o**: Usar vari√°veis de ambiente de `.ai-guards/plans/environment-variables.md`
   - **Padr√£o**: Usar `QueryClient` com `defaultOptions` conforme [guia de configura√ß√£o](https://tanstack.com/query/latest/docs/reference/QueryClient)
   - **Teste**: Verificar se aplica√ß√£o ainda funciona normalmente

5. **Adicionar QueryProvider ao layout**
   - Envolver aplica√ß√£o com `QueryClientProvider` conforme [quick start guide](https://tanstack.com/query/latest/docs/framework/react/quick-start)
   - Configurar DevTools apenas em desenvolvimento usando [React Query DevTools](https://tanstack.com/query/latest/docs/framework/react/devtools)
   - Arquivo: `app/layout.tsx` (atualizar)
   - Arquivo: `components/providers/query-provider.tsx` (novo)
   - **Teste**: Verificar se todas as p√°ginas carregam corretamente

6. **Otimizar autentica√ß√£o (Sem quebrar)**
   - Implementar cache de `getUserIdFromClerk()` no middleware
   - Adicionar header `x-user-id` como fallback (manter lookup original)
   - Arquivo: `lib/auth/auth-wrapper.ts` (atualizar)
   - Arquivo: `middleware.ts` (atualizar)
   - **Teste**: Verificar autentica√ß√£o em todas as rotas

7. **üö® CORRIGIR CONTADOR DE CLIENTES (CR√çTICO - PRIORIDADE ALTA)**
   - **PROBLEMA IDENTIFICADO**: Dashboard busca `data.total` mas API retorna `data.pagination.totalCount`
   - **Localiza√ß√£o**: `app/page.tsx` linha 32 - `setClientsCount(data.total || 0)`
   - **Corre√ß√£o Imediata**: Alterar para `setClientsCount(data.pagination?.totalCount || 0)`
   - Criar hook `useClientsCount` com TanStack Query usando padr√£o [useQuery](https://tanstack.com/query/latest/docs/framework/react/reference/useQuery)
   - Arquivo: `lib/query/hooks/use-clients-count.ts` (novo)
   - Arquivo: `app/page.tsx` (corrigir bug + implementar hook)
   - **Padr√£o**: `useQuery({ queryKey: ['clients-count'], queryFn: fetchClientsCount })`
   - **Refer√™ncia**: Ver an√°lise em `.ai-guards/plans/impact-analysis.md` se√ß√£o "Contador de Clientes Incorreto"
   - **Teste**: Verificar se contador mostra valor correto

### **Fase 2: Otimiza√ß√£o de API (Risco M√©dio) ‚úÖ COMPLETA**

8. **‚úÖ OTIMIZAR QUERIES DA API `/api/clients` (IMPLEMENTADO)**
   - ‚úÖ **CORRE√á√ÉO 1**: Query de `industries` agora √© condicional (apenas primeira p√°gina sem filtros)
   - ‚úÖ **CORRE√á√ÉO 2**: Implementada pagina√ß√£o otimizada com `LIMIT+1` para p√°ginas subsequentes
   - ‚úÖ **CORRE√á√ÉO 3**: Queries combinadas com `Promise.all` otimizado
   - ‚úÖ Arquivo: `app/api/clients/route.ts` - Otimiza√ß√µes implementadas
   - ‚úÖ **Performance**: Redu√ß√£o significativa de queries desnecess√°rias
   - ‚úÖ **Teste**: API mant√©m funcionalidade com melhor performance

9. **‚úÖ MIGRAR LISTAGEM PARA TANSTACK QUERY (IMPLEMENTADO)**
   - ‚úÖ Hook `useClients` criado com filtros completos: `lib/query/hooks/use-clients.ts`
   - ‚úÖ Hook `useClientsCount` criado para contador: `lib/query/hooks/use-clients-count.ts`
   - ‚úÖ Query keys padronizadas implementadas: `lib/query/keys.ts`
   - ‚úÖ QueryClient configurado: `lib/query/client.ts`
   - ‚úÖ QueryProvider adicionado ao layout: `app/layout.tsx`
   - ‚úÖ DevTools configuradas para desenvolvimento
   - ‚úÖ **Padr√£o**: `useQuery({ queryKey: queryKeys.clients.list(filters), queryFn: fetchClients })`

10. **‚úÖ IMPLEMENTAR INVALIDA√á√ÉO DE CACHE (IMPLEMENTADO)**
    - ‚úÖ Mutations CRUD completas: `lib/query/hooks/use-client-mutations.ts`
    - ‚úÖ Invalida√ß√£o autom√°tica ap√≥s mutations implementada
    - ‚úÖ Hook `useInvalidateClients` para invalida√ß√£o manual
    - ‚úÖ Hooks dispon√≠veis: `useCreateClient`, `useUpdateClient`, `useDeleteClient`, `useRestoreClient`
    - ‚úÖ **Padr√£o**: `queryClient.invalidateQueries({ queryKey: queryKeys.clients.all })`
    - ‚úÖ **Cache Strategy**: Invalida√ß√£o inteligente por tipo de opera√ß√£o

### **Fase 3: Implementa√ß√£o de Mutations**

11. **Implementar mutations para opera√ß√µes CRUD**
    - Criar mutations para criar, atualizar e deletar clientes usando [useMutation](https://tanstack.com/query/latest/docs/framework/react/reference/useMutation)
    - Implementar callbacks `onSuccess`, `onError`, `onSettled` conforme [guia de mutations](https://tanstack.com/query/latest/docs/framework/react/guides/mutations)
    - Arquivo: `lib/query/hooks/use-client-mutations.ts` (novo)
    - **Padr√£o**: 
      ```tsx
      useMutation({
        mutationFn: createClient,
        onSuccess: () => {
          queryClient.invalidateQueries({ queryKey: ['clients'] })
        }
      })
      ```
    - **Teste**: Verificar se mutations funcionam e invalidam cache

12. **Implementar optimistic updates**
    - Usar `onMutate` para updates otimistas conforme [documenta√ß√£o de optimistic updates](https://tanstack.com/query/latest/docs/framework/react/guides/optimistic-updates)
    - Implementar rollback em caso de erro usando `onError`
    - **Padr√£o**:
      ```tsx
      onMutate: async (newClient) => {
        await queryClient.cancelQueries({ queryKey: ['clients'] })
        const previousClients = queryClient.getQueryData(['clients'])
        queryClient.setQueryData(['clients'], (old) => [...old, newClient])
        return { previousClients }
      }
      ```

### **Fase 4: Otimiza√ß√£o de Banco (Alto Risco - Requer Cuidado)**

13. **Preparar migra√ß√£o de √≠ndices**
    - Consultar documenta√ß√£o Prisma via MCP Context7 sobre √≠ndices compostos
    - Criar migra√ß√£o SQL manual para controle total
    - Arquivo: `prisma/migrations/[timestamp]_optimize_client_indexes/migration.sql`
    - **Conte√∫do**:
      ```sql
      -- √çndice principal para queries mais comuns
      CREATE INDEX CONCURRENTLY "Client_userId_deletedAt_createdAt_idx" 
      ON "Client"("userId", "deletedAt", "createdAt" DESC);
      
      -- √çndice para busca por nome
      CREATE INDEX CONCURRENTLY "Client_userId_name_idx" 
      ON "Client"("userId", "name");
      
      -- √çndice para filtros avan√ßados
      CREATE INDEX CONCURRENTLY "Client_userId_industry_richnessScore_idx" 
      ON "Client"("userId", "industry", "richnessScore");
      ```

14. **Executar migra√ß√£o de √≠ndices (Hor√°rio de baixo tr√°fego)**
    - Usar `CREATE INDEX CONCURRENTLY` para n√£o bloquear tabela
    - Monitorar performance durante cria√ß√£o
    - Executar: `npx prisma db push` ou `npx prisma migrate deploy`
    - **Teste**: Verificar se √≠ndices foram criados corretamente

15. **Atualizar schema Prisma**
    - Adicionar novos √≠ndices ao `schema.prisma`
    - Executar `npx prisma db pull` para sincronizar
    - Arquivo: `prisma/schema.prisma` (atualizar)
    - **Teste**: Verificar se schema est√° consistente

### **Fase 5: Melhorias Avan√ßadas (Opcional)**

16. **Implementar pagina√ß√£o cursor-based**
    - Substituir offset por cursor para melhor performance
    - Atualizar API e frontend gradualmente
    - Manter compatibilidade com pagina√ß√£o atual
    - **Teste**: Verificar se pagina√ß√£o funciona com grandes datasets

17. **Adicionar cache Redis (Se necess√°rio)**
    - Configurar Redis para cache de queries frequentes
    - Implementar invalida√ß√£o inteligente
    - Arquivo: `lib/cache/redis.ts` (novo)
    - **Teste**: Verificar se cache Redis melhora performance

### **Arquivos que Precisam ser Alterados (Em Ordem de Implementa√ß√£o):**

#### **Fase 0 - Prepara√ß√£o: ‚úÖ COMPLETA**
- `üìÑ .ai-guards/plans/impact-analysis.md` ‚úÖ - An√°lise de impacto completa
- `üìÑ .ai-guards/plans/environment-variables.md` ‚úÖ - Vari√°veis de ambiente documentadas

#### **Fase 1 - Base TanStack Query:**
- `package.json` - Adicionar depend√™ncias
- `lib/query/client.ts` (novo) - Configura√ß√£o do QueryClient
- `lib/query/keys.ts` (novo) - Query keys padronizadas
- `components/providers/query-provider.tsx` (novo) - Provider
- `app/layout.tsx` - Adicionar QueryProvider
- `lib/query/hooks/use-clients-count.ts` (novo) - Hook contador
- `app/page.tsx` - Corrigir contador de clientes

#### **Fase 2 - Otimiza√ß√£o API:**
- `lib/auth/auth-wrapper.ts` - Cache de autentica√ß√£o
- `middleware.ts` - Header x-user-id
- `app/api/clients/route.ts` - Otimizar queries
- `lib/query/hooks/use-clients.ts` (novo) - Hook principal
- `components/client/client-list-with-filters.tsx` - Migrar para TanStack Query

#### **Fase 3 - Mutations:**
- `lib/query/hooks/use-client-mutations.ts` (novo) - Mutations CRUD
- Componentes que fazem opera√ß√µes CRUD - Migrar para mutations

#### **Fase 4 - Banco de Dados:**
- `prisma/migrations/[timestamp]_optimize_client_indexes/migration.sql` (novo)
- `prisma/schema.prisma` - Adicionar √≠ndices

#### **Fase 5 - Avan√ßado:**
- `lib/cache/redis.ts` (novo) - Cache Redis opcional

### **Comandos MCP Context7 Necess√°rios:**

```bash
# Consultar documenta√ß√£o antes de cada fase
mcp-context7 get-library-docs --library="@tanstack/react-query" --topic="best practices"
mcp-context7 get-library-docs --library="prisma" --topic="database indexes"
mcp-context7 get-library-docs --library="next.js" --topic="api routes performance"
mcp-context7 get-library-docs --library="react" --topic="suspense error boundaries"
```

### **Refer√™ncias da Documenta√ß√£o TanStack Query:**

- **Quick Start**: https://tanstack.com/query/latest/docs/framework/react/quick-start
- **useQuery Reference**: https://tanstack.com/query/latest/docs/framework/react/reference/useQuery
- **useMutation Reference**: https://tanstack.com/query/latest/docs/framework/react/reference/useMutation
- **Mutations Guide**: https://tanstack.com/query/latest/docs/framework/react/guides/mutations
- **Optimistic Updates**: https://tanstack.com/query/latest/docs/framework/react/guides/optimistic-updates
- **Query Invalidation**: https://tanstack.com/query/latest/docs/framework/react/guides/invalidations-from-mutations
- **DevTools**: https://tanstack.com/query/latest/docs/framework/react/devtools
- **Query Keys**: https://tanstack.com/query/latest/docs/framework/react/guides/query-keys

### **Crit√©rios de Rollback:**
- ‚ùå Tempo de resposta pior que o estado atual
- ‚ùå Erros de autentica√ß√£o
- ‚ùå Perda de dados ou funcionalidade
- ‚ùå Queries falhando > 5%
- ‚ùå Memory leaks detectados

### **M√©tricas de Sucesso:**
- ‚úÖ Redu√ß√£o significativa no tempo de resposta da API
- ‚úÖ Redu√ß√£o substancial no tempo total de carregamento
- ‚úÖ Contador de clientes mostrando valor correto
- ‚úÖ Cache hit rate otimizado
- ‚úÖ Elimina√ß√£o de queries desnecess√°rias em navega√ß√£o normal
- ‚úÖ Loading states suaves sem flickering
- ‚úÖ Zero downtime durante implementa√ß√£o
- ‚úÖ Todas as funcionalidades existentes mantidas
- ‚úÖ Melhor experi√™ncia do usu√°rio com feedback visual adequado
