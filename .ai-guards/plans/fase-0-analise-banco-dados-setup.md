 # Fase 0: An√°lise de Base de Dados e Setup Inicial - CONCLU√çDA

---
**Plan**: plan-005-cria√ß√£o-planejamento.md  
**Fase**: 0 - An√°lise de Base de Dados e Setup Inicial  
**Status**: ‚úÖ CONCLU√çDA  
**Data**: 2025-05-28  
**Executado por**: AI Assistant  
---

## üìä 1. An√°lise Completa do Schema Prisma

### üîç Mapeamento de Todos os Modelos Existentes

#### **Modelos Principais Identificados:**

1. **User** - Usu√°rio principal do sistema
2. **Client** - Clientes gerenciados pelos usu√°rios
3. **StrategicPlanning** - Planejamentos estrat√©gicos (J√Å EXISTE!)
4. **PlanningTask** - Tarefas vinculadas aos planejamentos
5. **AgentInteraction** - Intera√ß√µes com IA
6. **AgentMessage** - Mensagens das conversas com IA
7. **CommercialProposal** - Propostas comerciais
8. **SalesArgument** - Argumentos de vendas
9. **ClientNote** - Notas dos clientes
10. **ClientAttachment** - Anexos dos clientes
11. **TaskAttachment** - Anexos das tarefas
12. **TaskComment** - Coment√°rios das tarefas
13. **CreditTransaction** - Transa√ß√µes de cr√©ditos

### üÜî Mapeamento Completo de IDs e Relacionamentos

#### **Tipos de ID Identificados:**

| Tipo de ID | Modelo | Descri√ß√£o | Formato |
|------------|--------|-----------|---------|
| `id` | Todos os modelos | Chave prim√°ria √∫nica | `String @id @default(cuid())` |
| `userId` | User.id | ID interno do usu√°rio no sistema | `String @id @default(cuid())` |
| `clerkId` | User.clerkId | ID do usu√°rio no Clerk (auth) | `String @unique` |
| `clientId` | Client.id | ID do cliente | `String @id @default(cuid())` |
| `planningId` | StrategicPlanning.id | ID do planejamento estrat√©gico | `String @id @default(cuid())` |
| `strategicPlanningId` | PlanningTask.strategicPlanningId | FK para planejamento | `String?` |
| `agentInteractionId` | AgentInteraction.id | ID da intera√ß√£o com IA | `String @id @default(cuid())` |

#### **Relacionamentos Cr√≠ticos Mapeados:**

```prisma
// User (1) -> (N) Client
User.id -> Client.userId

// User (1) -> (N) StrategicPlanning  
User.id -> StrategicPlanning.userId

// Client (1) -> (N) StrategicPlanning
Client.id -> StrategicPlanning.clientId

// StrategicPlanning (1) -> (N) PlanningTask
StrategicPlanning.id -> PlanningTask.strategicPlanningId

// Client (1) -> (N) PlanningTask (opcional)
Client.id -> PlanningTask.clientId

// User (1) -> (N) AgentInteraction
User.id -> AgentInteraction.userId

// Client (1) -> (N) AgentInteraction
Client.id -> AgentInteraction.clientId
```

### ‚ö†Ô∏è **DESCOBERTA IMPORTANTE: StrategicPlanning J√Å EXISTE!**

O modelo `StrategicPlanning` j√° est√° implementado no schema atual:

```prisma
model StrategicPlanning {
  id                 String         @id @default(cuid())
  title              String
  description        String?
  specificObjectives String?
  scope              String?
  successMetrics     String?
  budget             String?
  toneOfVoice        String?
  status             PlanningStatus @default(DRAFT)
  clientId           String
  userId             String
  createdAt          DateTime       @default(now())
  updatedAt          DateTime
  PlanningTask       PlanningTask[]
  Client             Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  User               User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([userId])
}
```

**Status atual do PlanningStatus enum:**
```prisma
enum PlanningStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}
```

### üîÑ **Adapta√ß√µes Necess√°rias para Plan-005**

O modelo existente precisa ser **ESTENDIDO** para suportar o formul√°rio multi-etapas:

1. **Adicionar campos JSON**: `formDataJSON`, `clientSnapshot`
2. **Manter compatibilidade**: Campos existentes devem ser preservados
3. **Estender enum**: Adicionar status para IA (plan-006)

## üìã 2. An√°lise do Modelo Client

### **Campos Existentes Relevantes:**

```prisma
model Client {
  id                      String               @id @default(cuid())
  name                    String               // ‚úÖ Nome da empresa
  industry                String?              // ‚úÖ Setor (flex√≠vel no banco)
  serviceOrProduct        String?              // ‚úÖ Servi√ßo/Produto
  initialObjective        String?              // ‚úÖ Objetivo inicial
  contactEmail            String?              // ‚úÖ Email de contato
  contactPhone            String?              // ‚úÖ Telefone
  website                 String?              // ‚úÖ Website
  address                 String?              // ‚úÖ Endere√ßo
  businessDetails         String?              // ‚úÖ Detalhes do neg√≥cio
  targetAudience          String?              // ‚úÖ P√∫blico-alvo
  marketingObjectives     String?              // ‚úÖ Objetivos de marketing
  historyAndStrategies    String?              // ‚úÖ Hist√≥rico e estrat√©gias
  challengesOpportunities String?              // ‚úÖ Desafios e oportunidades
  competitors             String?              // ‚úÖ Concorrentes
  resourcesBudget         String?              // ‚úÖ Recursos e or√ßamento
  toneOfVoice             String?              // ‚úÖ Tom de voz
  preferencesRestrictions String?              // ‚úÖ Prefer√™ncias e restri√ß√µes
  richnessScore           Int                  @default(0) // ‚úÖ Score de riqueza
  userId                  String               // ‚úÖ Relacionamento com usu√°rio
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  deletedAt               DateTime?            // ‚úÖ Soft delete
  isViewed                Boolean              @default(false) // ‚úÖ Visualiza√ß√£o
  
  // Relacionamentos
  StrategicPlanning       StrategicPlanning[]  // ‚úÖ Planejamentos
  AgentInteraction        AgentInteraction[]   // ‚úÖ Chats IA
  PlanningTask            PlanningTask[]       // ‚úÖ Tarefas
  CommercialProposal      CommercialProposal[] // ‚úÖ Propostas
  ClientNote              ClientNote[]         // ‚úÖ Notas
  ClientAttachment        ClientAttachment[]   // ‚úÖ Anexos
}
```

### **Campo `customIndustry` - VERIFICA√á√ÉO NECESS√ÅRIA**

‚ö†Ô∏è **ATEN√á√ÉO**: O campo `customIndustry` mencionado no plan-005 **N√ÉO EXISTE** no schema atual. 

**Op√ß√µes:**
1. **Usar campo existente**: `industry` pode armazenar "Outro: [descri√ß√£o personalizada]"
2. **Adicionar campo**: Criar `customIndustry String?` se necess√°rio
3. **Usar businessDetails**: Campo existente pode armazenar detalhes personalizados

**Recomenda√ß√£o**: Usar `industry` flex√≠vel e `businessDetails` para detalhes adicionais.

## üîß 3. Configura√ß√£o de Vari√°veis de Ambiente

### **Arquivo .env Atual Analisado:**

```env
# Database
DATABASE_URL=postgresql://postgres.yikhktawbwnywlbsnjns:Dantevault.28@aws-0-sa-east-1.pooler.supabase.com:6543/postgres?pgbouncer=true

# Supabase  
NEXT_PUBLIC_SUPABASE_URL="https://yikhktawbwnywlbsnjns.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Clerk (Auth)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_[CHAVE_MASCARADA_POR_SEGURAN√áA]
CLERK_SECRET_KEY=sk_test_[CHAVE_MASCARADA_POR_SEGURAN√áA]
DIRECT_URL="postgresql://postgres.yikhktawbwnywlbsnjns:Dantevault.28@aws-0-sa-east-1.pooler.supabase.com:5432/postgres"
CLERK_WEBHOOK_SECRET="whsec_/fulb5H9S55UnSWdPlbRyN43LBJ6iDcL"

# Configura√ß√£o do Servidor
PORT=3003

# URLs do Clerk
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/clientes
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/clientes
NEXT_PUBLIC_CLERK_DOMAIN=http://5.161.64.137:3003
```

### **Vari√°veis a Serem Adicionadas (Plan-005 + Plan-006):**

```env
# Webhooks para IA (plan-006)
PLANNING_WEBHOOK_URL="https://webhook.lucasfelix.com/webhook/vortex-planejamento-beta-2025"
REFINED_LIST_WEBHOOK_URL="https://webhook.lucasfelix.com/webhook/vortex-refinada-beta-2025"
WEBHOOK_SECRET="[secret-key-to-be-defined]"

# Custos de cr√©ditos (plan-006)
COST_PLANNING_BACKLOG_VISIBLE=10
COST_REFINED_LIST_VISIBLE=10
```

## üèóÔ∏è 4. Atualiza√ß√£o do Schema Prisma Necess√°ria

### **Modifica√ß√µes no Modelo StrategicPlanning:**

```prisma
model StrategicPlanning {
  id                 String         @id @default(cuid())
  userId             String         // ‚úÖ J√° existe
  clientId           String         // ‚úÖ J√° existe
  
  // Campos existentes (manter compatibilidade)
  title              String         // ‚úÖ J√° existe
  description        String?        // ‚úÖ J√° existe
  specificObjectives String?        // ‚úÖ J√° existe
  scope              String?        // ‚úÖ J√° existe
  successMetrics     String?        // ‚úÖ J√° existe
  budget             String?        // ‚úÖ J√° existe
  toneOfVoice        String?        // ‚úÖ J√° existe
  status             PlanningStatus @default(DRAFT) // ‚úÖ J√° existe
  
  // üÜï NOVOS CAMPOS PARA PLAN-005
  formDataJSON       Json?          // Dados completos do formul√°rio (4 abas)
  clientSnapshot     Json?          // Snapshot dos dados do cliente
  
  // Timestamps
  createdAt          DateTime       @default(now()) // ‚úÖ J√° existe
  updatedAt          DateTime       @updatedAt      // ‚úÖ J√° existe
  
  // Relacionamentos (j√° existem)
  client             Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  PlanningTask       PlanningTask[]
  
  // √çndices (j√° existem)
  @@index([clientId])
  @@index([userId])
  @@index([userId, clientId])    // üÜï Adicionar
  @@index([userId, status])      // üÜï Adicionar
}
```

### **Extens√£o do Enum PlanningStatus (Prepara√ß√£o Plan-006):**

```prisma
enum PlanningStatus {
  // Status atuais (manter)
  DRAFT                           // ‚úÖ J√° existe
  ACTIVE                          // ‚úÖ J√° existe  
  COMPLETED                       // ‚úÖ J√° existe
  ARCHIVED                        // ‚úÖ J√° existe
  
  // üÜï Status para Plan-006 (IA)
  PENDING_AI_BACKLOG_GENERATION   // Aguardando gera√ß√£o IA
  AI_BACKLOG_VISIBLE              // Backlog IA vis√≠vel
  PENDING_AI_REFINED_LIST         // Aguardando lista refinada
  AI_REFINED_LIST_VISIBLE         // Lista refinada vis√≠vel
}
```

## üìÅ 5. Estrutura de Arquivos Identificada

### **Arquivos Cr√≠ticos Localizados:**

```
/root/Vortex/precedent/
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma              # ‚úÖ Schema principal analisado
‚îÇ   ‚îú‚îÄ‚îÄ migrations/                # ‚úÖ Hist√≥rico de migra√ß√µes
‚îÇ   ‚îî‚îÄ‚îÄ rls-policies.sql          # ‚úÖ Pol√≠ticas RLS
‚îú‚îÄ‚îÄ .env                          # ‚úÖ Vari√°veis de ambiente
‚îú‚îÄ‚îÄ env.example                   # ‚úÖ Template de vari√°veis
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ Flowchart Vortex.mmd     # ‚úÖ Arquitetura do sistema
‚îÇ   ‚îî‚îÄ‚îÄ formulario.md            # üìã Estrutura do formul√°rio
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ prisma/
‚îÇ       ‚îî‚îÄ‚îÄ client.ts            # ‚úÖ Cliente Prisma
‚îî‚îÄ‚îÄ .ai-guards/
    ‚îî‚îÄ‚îÄ plans/                   # ‚úÖ Documenta√ß√£o de planos
```

## üîç 6. Verifica√ß√£o de Integridade Referencial

### **Relacionamentos Validados:**

‚úÖ **User ‚Üî Client**: `Client.userId -> User.id`  
‚úÖ **User ‚Üî StrategicPlanning**: `StrategicPlanning.userId -> User.id`  
‚úÖ **Client ‚Üî StrategicPlanning**: `StrategicPlanning.clientId -> Client.id`  
‚úÖ **StrategicPlanning ‚Üî PlanningTask**: `PlanningTask.strategicPlanningId -> StrategicPlanning.id`  
‚úÖ **Client ‚Üî AgentInteraction**: `AgentInteraction.clientId -> Client.id`  
‚úÖ **User ‚Üî AgentInteraction**: `AgentInteraction.userId -> User.id`  

### **Pol√≠ticas de Cascata:**

- `Client -> StrategicPlanning`: `onDelete: Cascade` ‚úÖ
- `User -> StrategicPlanning`: `onDelete: Cascade` ‚úÖ
- `StrategicPlanning -> PlanningTask`: Relacionamento opcional ‚úÖ

## üìä 7. An√°lise do Flowchart Vortex.mmd

### **Fluxos Relevantes Identificados:**

1. **ClientFlow**: Sistema de sele√ß√£o/cria√ß√£o de cliente ‚úÖ
2. **Planning**: Cria√ß√£o de planejamento estrat√©gico ‚úÖ  
3. **Dashboard**: Interface principal com widgets ‚úÖ
4. **QuickCreate**: Modal de cria√ß√£o universal ‚úÖ

### **Pontos de Integra√ß√£o Plan-005:**

- **CLIENT_MODAL**: Reutilizar modal existente com adapta√ß√µes ‚úÖ
- **PLAN_CLIENT_SELECT**: Integra√ß√£o obrigat√≥ria com cliente ‚úÖ
- **PLAN_FORM**: Formul√°rio multi-etapas ‚úÖ
- **AI_STRUCTURE_GEN**: Prepara√ß√£o para plan-006 ‚úÖ

## ‚úÖ 8. Conclus√µes e Pr√≥ximos Passos

### **Status da An√°lise:**

üü¢ **SCHEMA MAPEADO**: Todos os modelos e relacionamentos identificados  
üü¢ **IDs DOCUMENTADOS**: Tipos de ID e suas rela√ß√µes mapeadas  
üü¢ **INTEGRIDADE VALIDADA**: Relacionamentos consistentes  
üü¢ **VARI√ÅVEIS PREPARADAS**: .env pronto para extens√£o  
üü° **MODELO EXISTENTE**: StrategicPlanning j√° existe, precisa extens√£o  

### **Descobertas Importantes:**

1. **StrategicPlanning j√° implementado**: Modelo base existe, precisa apenas de campos JSON
2. **Client.customIndustry n√£o existe**: Usar `industry` + `businessDetails`
3. **Relacionamentos s√≥lidos**: Integridade referencial bem estruturada
4. **Enum PlanningStatus**: Precisa extens√£o para status de IA

### **Prepara√ß√£o para Pr√≥ximas Fases:**

‚úÖ **Fase 1**: Adapta√ß√£o da UI de Cliente (modal existente)  
‚úÖ **Fase 2**: Formul√°rio multi-etapas (estrutura JSON preparada)  
‚úÖ **Fase 3**: Backend APIs (relacionamentos mapeados)  
‚úÖ **Fase 4**: Painel de visualiza√ß√£o (modelo existente)  
‚úÖ **Fase 5**: Integra√ß√£o na UI (pontos identificados)  

### **Arquivos de Migra√ß√£o Necess√°rios:**

1. **Adicionar campos JSON** ao StrategicPlanning
2. **Estender enum PlanningStatus** 
3. **Adicionar √≠ndices** otimizados
4. **Atualizar tipos TypeScript**

---

## üìã Checklist de Execu√ß√£o da Fase 0

- [x] **An√°lise completa do schema Prisma**
- [x] **Mapeamento de todos os tipos de ID**
- [x] **Identifica√ß√£o de relacionamentos existentes**
- [x] **Verifica√ß√£o de integridade referencial**
- [x] **An√°lise do arquivo .env existente**
- [x] **Prepara√ß√£o de vari√°veis para plan-006**
- [x] **Documenta√ß√£o de estruturas JSON**
- [x] **An√°lise do flowchart de arquitetura**
- [x] **Identifica√ß√£o de pontos de integra√ß√£o**
- [x] **Prepara√ß√£o para pr√≥ximas fases**

---

**üéØ FASE 0 CONCLU√çDA COM SUCESSO**

**Pr√≥xima Fase**: Fase 1 - Adapta√ß√£o da UI de Cliente para Planejamento  
**Depend√™ncias Resolvidas**: Todos os IDs e relacionamentos mapeados  
**Estruturas Preparadas**: JSON schemas e vari√°veis de ambiente prontas  