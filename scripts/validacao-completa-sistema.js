/**
 * üß™ VALIDA√á√ÉO COMPLETA DO SISTEMA DE APROVA√á√ÉO
 * Script autom√°tico para testar Phases 1, 2 e 3
 */

require('dotenv').config({ path: '.env' });
const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();

console.log('üîç'.repeat(60));
console.log('üß™ VALIDA√á√ÉO COMPLETA - Sistema de Aprova√ß√£o Phases 1, 2, 3');
console.log('üîç'.repeat(60));

async function validacaoCompleta() {
  try {
    let totalScore = 0;
    const maxScore = 50; // Total de pontos poss√≠veis

    // ====================================================
    // VALIDA√á√ÉO PHASE 1: DATABASE SCHEMA
    // ====================================================
    console.log('\nüîç PHASE 1: Database Schema & Environment Setup');
    console.log('-'.repeat(50));

    let phase1Score = 0;

    try {
      // Testar conex√£o
      await prisma.$connect();
      console.log('‚úÖ Conex√£o com banco: OK');
      phase1Score += 2;

      // Verificar campos de aprova√ß√£o na tabela User
      const userSchema = await prisma.$queryRaw`
        SELECT column_name, data_type, is_nullable, column_default
        FROM information_schema.columns 
        WHERE table_name = 'User' 
        AND column_name IN ('approvalStatus', 'approvedAt', 'approvedBy', 'rejectedAt', 'rejectedBy', 'rejectionReason', 'version')
        ORDER BY column_name;
      `;

      const expectedFields = ['approvalStatus', 'approvedAt', 'approvedBy', 'rejectedAt', 'rejectedBy', 'rejectionReason', 'version'];
      const foundFields = userSchema.map(col => col.column_name);
      
      console.log(`‚úÖ Campos de aprova√ß√£o encontrados: ${foundFields.length}/${expectedFields.length}`);
      foundFields.forEach(field => console.log(`   - ${field}: ‚úÖ`));
      
      if (foundFields.length === expectedFields.length) phase1Score += 5;

      // Verificar tabela UserModerationLog
      const logTable = await prisma.$queryRaw`
        SELECT COUNT(*) as count FROM information_schema.tables 
        WHERE table_name = 'UserModerationLog';
      `;

      if (logTable[0].count > 0) {
        console.log('‚úÖ Tabela UserModerationLog: Existe');
        phase1Score += 3;
      } else {
        console.log('‚ùå Tabela UserModerationLog: N√£o encontrada');
      }

      // Verificar enums
      const enums = await prisma.$queryRaw`
        SELECT typname FROM pg_type 
        WHERE typtype = 'e' 
        AND typname IN ('ApprovalStatus', 'ModerationAction');
      `;

      console.log(`‚úÖ Enums encontrados: ${enums.length}/2`);
      enums.forEach(en => console.log(`   - ${en.typname}: ‚úÖ`));
      
      if (enums.length >= 2) phase1Score += 2;

    } catch (error) {
      console.log('‚ùå Erro na valida√ß√£o Phase 1:', error.message);
    }

    console.log(`üìä PHASE 1 Score: ${phase1Score}/12`);
    totalScore += phase1Score;

    // ====================================================
    // VALIDA√á√ÉO PHASE 2: RLS SECURITY
    // ====================================================
    console.log('\nüõ°Ô∏è PHASE 2: Supabase RLS Security Layer');
    console.log('-'.repeat(50));

    let phase2Score = 0;

    try {
      // Verificar fun√ß√µes RLS
      const functions = await prisma.$queryRaw`
        SELECT proname FROM pg_proc 
        WHERE proname IN ('get_current_user_approval_status', 'is_current_user_admin', 'get_user_id_from_clerk');
      `;

      console.log(`‚úÖ Fun√ß√µes RLS: ${functions.length}/3`);
      functions.forEach(fn => console.log(`   - ${fn.proname}: ‚úÖ`));
      
      if (functions.length === 3) phase2Score += 5;

      // Verificar RLS habilitado
      const rlsTables = await prisma.$queryRaw`
        SELECT tablename, rowsecurity FROM pg_tables 
        WHERE tablename IN ('User', 'Client', 'StrategicPlanning', 'CommercialProposal', 'UserModerationLog', 'CreditTransaction')
        AND rowsecurity = true;
      `;

      console.log(`‚úÖ Tabelas com RLS: ${rlsTables.length}/6`);
      rlsTables.forEach(table => console.log(`   - ${table.tablename}: ‚úÖ`));
      
      if (rlsTables.length >= 5) phase2Score += 5;

      // Verificar pol√≠ticas RLS
      const policies = await prisma.$queryRaw`
        SELECT tablename, COUNT(*) as policy_count
        FROM pg_policies 
        WHERE tablename IN ('User', 'Client', 'StrategicPlanning', 'CommercialProposal', 'UserModerationLog', 'CreditTransaction')
        GROUP BY tablename
        ORDER BY tablename;
      `;

      const totalPolicies = policies.reduce((sum, table) => sum + parseInt(table.policy_count), 0);
      console.log(`‚úÖ Pol√≠ticas RLS totais: ${totalPolicies}`);
      policies.forEach(table => console.log(`   - ${table.tablename}: ${table.policy_count} pol√≠ticas`));
      
      if (totalPolicies >= 10) phase2Score += 5;

    } catch (error) {
      console.log('‚ùå Erro na valida√ß√£o Phase 2:', error.message);
    }

    console.log(`üìä PHASE 2 Score: ${phase2Score}/15`);
    totalScore += phase2Score;

    // ====================================================
    // VALIDA√á√ÉO PHASE 3: CLERK INTEGRATION
    // ====================================================
    console.log('\nüîó PHASE 3: Clerk Integration & Webhook Enhancement');
    console.log('-'.repeat(50));

    let phase3Score = 0;

    try {
      const fs = require('fs');

      // Verificar webhook atualizado
      if (fs.existsSync('./app/api/webhooks/clerk/route.ts')) {
        const webhookContent = fs.readFileSync('./app/api/webhooks/clerk/route.ts', 'utf8');
        
        const webhookFeatures = [
          'approval-system',
          'clerkClient',
          'updateUserMetadata',
          'logApprovalAction',
          'getEnvironment',
          'getBaseUrl',
          'version',
          'creditBalance'
        ];

        let webhookScore = 0;
        webhookFeatures.forEach(feature => {
          if (webhookContent.includes(feature)) {
            webhookScore++;
            console.log(`   - ${feature}: ‚úÖ`);
          } else {
            console.log(`   - ${feature}: ‚ùå`);
          }
        });

        console.log(`‚úÖ Webhook features: ${webhookScore}/${webhookFeatures.length}`);
        if (webhookScore >= 6) phase3Score += 5;
      }

      // Verificar utilit√°rios de integra√ß√£o
      if (fs.existsSync('./utils/clerk-integration.ts')) {
        const integrationContent = fs.readFileSync('./utils/clerk-integration.ts', 'utf8');
        
        const utilFunctions = [
          'getClerkWebhookUrl',
          'getWebhookConfig',
          'syncClerkMetadata',
          'updateUserApprovalStatus',
          'verifyClerkUser'
        ];

        let utilScore = 0;
        utilFunctions.forEach(fn => {
          if (integrationContent.includes(fn)) {
            utilScore++;
            console.log(`   - ${fn}: ‚úÖ`);
          } else {
            console.log(`   - ${fn}: ‚ùå`);
          }
        });

        console.log(`‚úÖ Utilit√°rios: ${utilScore}/${utilFunctions.length}`);
        if (utilScore >= 4) phase3Score += 5;
      }

      // Verificar sistema de aprova√ß√£o base
      if (fs.existsSync('./utils/approval-system.ts')) {
        const approvalContent = fs.readFileSync('./utils/approval-system.ts', 'utf8');
        
        const baseFunctions = [
          'getBaseUrl',
          'getEnvironment',
          'APPROVAL_STATUS',
          'MODERATION_ACTION'
        ];

        let baseScore = 0;
        baseFunctions.forEach(fn => {
          if (approvalContent.includes(fn)) {
            baseScore++;
            console.log(`   - ${fn}: ‚úÖ`);
          } else {
            console.log(`   - ${fn}: ‚ùå`);
          }
        });

        console.log(`‚úÖ Sistema base: ${baseScore}/${baseFunctions.length}`);
        if (baseScore >= 3) phase3Score += 3;
      }

    } catch (error) {
      console.log('‚ùå Erro na valida√ß√£o Phase 3:', error.message);
    }

    console.log(`üìä PHASE 3 Score: ${phase3Score}/13`);
    totalScore += phase3Score;

    // ====================================================
    // VALIDA√á√ÉO ENVIRONMENT
    // ====================================================
    console.log('\n‚öôÔ∏è ENVIRONMENT VALIDATION');
    console.log('-'.repeat(50));

    let envScore = 0;

    const requiredEnvVars = [
      'CLERK_SECRET_KEY',
      'CLERK_WEBHOOK_SECRET', 
      'NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY',
      'NEXT_PUBLIC_SUPABASE_URL',
      'SUPABASE_SERVICE_ROLE_KEY',
      'DATABASE_URL'
    ];

    requiredEnvVars.forEach(envVar => {
      if (process.env[envVar]) {
        console.log(`‚úÖ ${envVar}: Configurado`);
        envScore++;
      } else {
        console.log(`‚ùå ${envVar}: Ausente`);
      }
    });

    const environment = process.env.VERCEL_ENV === 'production' ? 'production' :
                       process.env.VERCEL_ENV === 'preview' ? 'preview' : 'development';
    
    const baseUrl = process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` :
                   process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3003';

    console.log(`‚úÖ Ambiente detectado: ${environment}`);
    console.log(`‚úÖ Base URL: ${baseUrl}`);
    console.log(`‚úÖ Webhook URL: ${baseUrl}/api/webhooks/clerk`);

    if (envScore >= 5) envScore = 10; // Bonus para env completo

    console.log(`üìä ENVIRONMENT Score: ${envScore}/10`);
    totalScore += envScore;

    // ====================================================
    // TESTE SIMULADO DE USU√ÅRIO
    // ====================================================
    console.log('\nüë§ SIMULA√á√ÉO DE USU√ÅRIO');
    console.log('-'.repeat(50));

    try {
      // Simular dados de usu√°rio
      const testUserData = {
        clerkId: `test_user_${Date.now()}`,
        email: `test${Date.now()}@validation.com`,
        firstName: 'Test',
        lastName: 'Validation',
        approvalStatus: 'PENDING',
        creditBalance: 0,
        version: 0
      };

      console.log('‚úÖ Dados de teste gerados:');
      console.log(`   - Clerk ID: ${testUserData.clerkId}`);
      console.log(`   - Email: ${testUserData.email}`);
      console.log(`   - Status: ${testUserData.approvalStatus}`);
      console.log(`   - Cr√©ditos: ${testUserData.creditBalance}`);

      // Verificar se consegue inserir (sem de fato inserir)
      console.log('‚úÖ Estrutura de dados v√°lida para inser√ß√£o');
      
    } catch (error) {
      console.log('‚ùå Erro na simula√ß√£o:', error.message);
    }

    // ====================================================
    // RELAT√ìRIO FINAL
    // ====================================================
    console.log('\n' + '='.repeat(60));
    console.log('üìä RELAT√ìRIO FINAL DE VALIDA√á√ÉO');
    console.log('='.repeat(60));

    const finalScore = Math.round((totalScore / maxScore) * 100);

    console.log(`üéØ SCORE TOTAL: ${totalScore}/${maxScore} (${finalScore}%)`);
    console.log('');
    console.log('üìà BREAKDOWN POR PHASE:');
    console.log(`   üîç Phase 1 (Database): ${phase1Score}/12`);
    console.log(`   üõ°Ô∏è Phase 2 (Security): ${phase2Score}/15`);
    console.log(`   üîó Phase 3 (Integration): ${phase3Score}/13`);
    console.log(`   ‚öôÔ∏è Environment: ${envScore}/10`);

    // Classifica√ß√£o final
    let classification;
    if (finalScore >= 90) classification = 'üèÜ EXCELENTE';
    else if (finalScore >= 80) classification = '‚úÖ BOM';
    else if (finalScore >= 70) classification = '‚ö†Ô∏è REGULAR';
    else if (finalScore >= 60) classification = 'üîÑ PRECISA MELHORAR';
    else classification = '‚ùå INSUFICIENTE';

    console.log(`\nüèÜ CLASSIFICA√á√ÉO: ${classification}`);

    // Recomenda√ß√µes
    console.log('\nüìã PR√ìXIMAS A√á√ïES RECOMENDADAS:');
    
    if (finalScore >= 90) {
      console.log('‚úÖ Sistema pronto para Phase 4: Admin Dashboard');
      console.log('‚úÖ Todas as funcionalidades b√°sicas implementadas');
      console.log('‚úÖ Seguran√ßa e integra√ß√£o funcionais');
    } else if (finalScore >= 80) {
      console.log('‚ö†Ô∏è Revisar itens faltantes antes de prosseguir');
      console.log('‚ö†Ô∏è Alguns componentes precisam de ajustes');
    } else {
      console.log('‚ùå Implementa√ß√£o incompleta - revisar phases');
      console.log('‚ùå Corrigir problemas antes de continuar');
    }

    console.log('\nüí° DICAS PARA TESTE MANUAL:');
    console.log('1. Verifique Supabase Dashboard ‚Üí Database ‚Üí Tables');
    console.log('2. Verifique Clerk Dashboard ‚Üí Webhooks');
    console.log('3. Teste cria√ß√£o de usu√°rio em modo incognito');
    console.log('4. Execute queries SQL no Supabase para testar RLS');

    return {
      totalScore,
      finalScore,
      classification,
      breakdown: {
        phase1: phase1Score,
        phase2: phase2Score,
        phase3: phase3Score,
        environment: envScore
      }
    };

  } catch (error) {
    console.error('\n‚ùå ERRO GERAL NA VALIDA√á√ÉO:', error.message);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

// Executar valida√ß√£o
(async () => {
  try {
    const result = await validacaoCompleta();
    
    console.log('\n' + 'üéâ'.repeat(20));
    console.log(`üéâ VALIDA√á√ÉO CONCLU√çDA: ${result.classification} (${result.finalScore}%)`);
    console.log('üéâ'.repeat(20));

  } catch (error) {
    console.error('\n‚ùå ERRO CR√çTICO:', error.message);
    process.exit(1);
  }
})(); 